# Wrike Webhook Handler

## Описание

**Wrike Webhook Handler** — это система автоматических уведомлений для интеграции между платформой управления проектами Wrike и мессенджером Telegram. Проект предназначен для мониторинга изменений в задачах Wrike и отправки уведомлений в Telegram-чат при возникновении определенных событий.

## Назначение и применение

### Основные функции:
- **Мониторинг событий Wrike**: Отслеживание изменений статуса, важности, ответственных и комментариев в задачах
- **Автоматические уведомления**: Отправка форматированных сообщений в Telegram при возникновении событий
- **Фильтрация задач**: Обработка только определенных типов задач (настраивается в конфигурации)
- **Кэширование данных**: Оптимизация работы с API Wrike через кэширование проектов и пользователей
- **Админ-панель**: Веб-интерфейс для мониторинга состояния системы и диагностики

### Где может использоваться:
- **Команды разработки**: Уведомления о изменениях в задачах проекта
- **Службы поддержки**: Мониторинг инцидентов и обращений
- **Менеджеры проектов**: Отслеживание прогресса и статусов задач
- **IT-отделы**: Уведомления о технических задачах и проблемах
- **Любые команды**: Использующие Wrike для управления задачами и нуждающиеся в оперативных уведомлениях

## Структура проекта

```
webhook-wrike/
├── webhook.py              # Основное приложение FastAPI
├── config.yaml             # Конфигурация системы
├── requirements.txt        # Зависимости Python
├── Curl.py                 # Скрипт для создания webhook в Wrike
├── log_config.py           # Настройки логирования
├── .env                    # Переменные окружения (токены)
├── Daemon/                 # Systemd службы (Для примера)
│   ├── webhook.service     # Служба основного приложения
│   └── ngrok.service       # Служба туннелирования ngrok
├── logging/                # Логи приложения (с ротацией)
│   └── webhook.log
├── doc.md                  # Документация по установке
└── README.md               
```

## Установка

### 1. Подготовка системы

```bash
# Создание виртуального окружения
python3 -m venv /home/user/myenv
source /home/user/myenv/bin/activate

# Создание директории проекта
mkdir -p /home/user/project
cd /home/user/project
```

### 2. Установка зависимостей

```bash
# Активация виртуального окружения
source /home/user/myenv/bin/activate

# Установка зависимостей
pip install -r requirements.txt
```

### 3. Настройка конфигурации

Создайте файл `.env` в корне проекта:
```bash
# Токен Telegram бота (получить у @BotFather)
TELEGRAM_TOKEN=your_telegram_bot_token
# ID чата Telegram (можно узнать у @userinfobot)
CHAT_ID=your_telegram_chat_id
# Токен Wrike API (получить в Wrike -> Приложения и интеграция)
ACCESS_TOKEN=your_wrike_access_token
```

Настройте `config.yaml` согласно вашим требованиям (заголовки задач, пользователи, синонимы).

### 4. Тестирование приложения

```bash
# Запуск для проверки
python /home/user/project/webhook.py
```

### 5. Создание системной службы

Создайте файл службы:
```bash
sudo nano /etc/systemd/system/webhook.service
```

Содержимое файла службы:
```ini
[Unit]
Description=Gunicorn instance to serve Flask webhook
After=network.target

[Service]
User=your_user_name
Group=www-data
WorkingDirectory=/home/your_user_name/project
Environment="PATH=/home/your_user_name/myenv/bin"
ExecStart=/home/your_user_name/myenv/bin/python /home/your_user_name/project/webhook.py

[Install]
WantedBy=multi-user.target
```

**Важно**: Замените `your_user_name` на ваше имя пользователя.

### 6. Активация службы

```bash
# Перезагрузка systemd
sudo systemctl daemon-reload

# Запуск службы
sudo systemctl start webhook.service

# Автозапуск при старте системы
sudo systemctl enable webhook.service

# Проверка статуса
sudo systemctl status webhook.service
```

![webhook-service](https://github.com/user-attachments/assets/31e426cb-05ab-4510-bb16-d85f2ec923cf)

### 7. Установка и настройка ngrok

```bash
# Скачивание и установка ngrok
wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar -xvf ngrok-v3-stable-linux-amd64.tgz
sudo mv ngrok /usr/local/bin/

# Настройка токена
ngrok authtoken YOUR_NGROK_TOKEN

# Тестирование
ngrok http 5555
```

### 8. Создание службы ngrok

```bash
sudo nano /etc/systemd/system/ngrok.service
```

Содержимое:
```ini
[Unit]
Description=Ngrok HTTP Tunnel
After=network.target

[Service]
ExecStart=/usr/local/bin/ngrok http 5555
WorkingDirectory=/home/your_user_name
StandardOutput=inherit
StandardError=inherit
Restart=always
User=your_user_name

[Install]
WantedBy=multi-user.target
```

### 9. Активация службы ngrok

```bash
sudo systemctl daemon-reload
sudo systemctl start ngrok
sudo systemctl enable ngrok
sudo systemctl status ngrok.service
```

![ngrok](https://github.com/user-attachments/assets/d7d6ed90-d816-488d-a5be-045b79b0cc27)


**Примечание**: После выполнения `sudo systemctl enable ngrok` вы увидите сообщение:
```
Created symlink /etc/systemd/system/multi-user.target.wants/ngrok.service → /etc/systemd/system/ngrok.service.
```

Это означает, что systemd создал символическую ссылку для автоматического запуска службы ngrok при загрузке системы. Без этой ссылки служба запускалась бы только вручную и не перезапускалась при перезагрузке сервера.

### 10. Настройка webhook в Wrike

1. Получите публичный URL из ngrok:
По умолчанию, Ngrok использует порт 4040 для своего веб-интерфейса и API
```bash
curl http://localhost:4040/api/tunnels
```
Этот запрос вернет JSON с информацией о всех активных туннелях, включая публичные URL, его нужно будет скопировать, зайти в файл Curl.py и вставить в переменную WEBHOOK_URL

![piblic_url](https://github.com/user-attachments/assets/052aad82-ab6c-4583-af01-97b22bb1522f)

```python
WEBHOOK_URL = 'https://your-ngrok-url.ngrok-free.app/webhooks'
```
После идём в Wrike -> Приложения и интеграция -> API -> + Приложение (создаём приложение). Название приложение можете написать любое. Далее находим строку 
(URL-адреса переадресации *) и вставляем туда публичный url из ngrok. Ниже находим строку (Постоянный токен доступа) и нажимаем на кнопку "Получить токен" копируем этот токент и сохраняем. Это токен wrike API его нужно будет вставить в переменную ACCESS_TOKEN= в файле .env и в переменную ACCESS_TOKEN= в файле Curl.py После всех манипуляций запускаем Curl.py, чтобы создать webhook связь.

![Wkike](https://github.com/user-attachments/assets/52c79b84-7263-49df-8e47-5d37743b465c)

2. Запустите скрипт для создания webhook:
```bash
python3 Curl.py
```

![curl](https://github.com/user-attachments/assets/3e90bf41-36c8-4ae6-b521-e8a13fde2962)

Если видим сообщение Webhook created successfully значит туннель работает. Если нет, проверяем всё ли правильно сделали.

### 11. Проверка

- **Админ-панель**: `http://your-server:5555/docs`
В файле config.yaml логин и пароль стоят по умолчанию admin amin
- **Статус служб**: `sudo systemctl status webhook.service ngrok.service`
- **Логи**: `tail -f logging/webhook.log`

Первое что делаем проверяем связь до wrike и вашего telegram. Если возвращаются ответы 200 значит всё ок.

## Возможности админ-панели

### Доступные эндпоинты в админ-панели: `http://your-server:5555/docs`:

- **`/admin/cache`** - Текущее состояние кэша Wrike (проекты и пользователи)
- **`/admin/errors`** - Последние 20 ошибок, произошедших в обработчике
- **`/admin/logs`** - Последние N строк из лог-файла (по умолчанию 50)
- **`/admin/download_logs`** - Скачать лог-файл целиком
- **`/admin/clear_cache`** - Очистить кэш проектов и пользователей
- **`/admin/ngrok_tunnels`** - Информация о всех активных туннелях ngrok (если используется)
- **`/admin/health`** - Статус сервиса и аптайм
- **`/admin/stats`** - Статистика по обработанным вебхукам, отправленным сообщениям, ошибкам
- **`/admin/last_webhooks`** - Последние 20 обработанных вебхуков
- **`/admin/config`** - Просмотр текущих настроек (без чувствительных данных)
- **`/admin/wrike_ping`** - Тестовый запрос к Wrike API (проверка доступности и токена)
- **`/admin/telegram_ping`** - Тестовая отправка сообщения в Telegram ("Проверка связи")
- **`/webhooks`** - Приём и обработка вебхуков от Wrike

 - Описание каждого эндпоинта: метод (GET/POST), путь, параметры, структура запроса и ответа;
 - Возможность авторизации (кнопка Authorize);
 - Возможность отправлять реальные запросы к API прямо из браузера и видеть ответы в реальном времени

### Примеры эндпоинтов:

- **`/admin/wrike_ping`** - Тестовый запрос к Wrike API (проверка доступности и токена)

![Тестовая отправка сообщения в Telegram](https://github.com/user-attachments/assets/2f872f74-7f59-43c2-a83a-4822df76859f)

- **`/admin/wrike_ping`** - Тестовый запрос к Wrike API (проверка доступности и токена)

![Тестовый запрос к Wrike API](https://github.com/user-attachments/assets/a032eed6-b507-40e5-8cfd-21058bfceb14)

## Мониторируемые события

- **TaskStatusChanged** - Изменение статуса задачи
- **TaskImportanceChanged** - Изменение важности
- **TaskResponsiblesAdded/Removed** - Изменение ответственных
- **CommentAdded** - Добавление комментариев
- **TaskDescriptionChanged** - Изменение описания


### Файл config.yaml
``` yml
# Список заголовков задач, которые будут отслеживаться
# Система будет обрабатывать только задачи с этими заголовками
task_titles:
  - "Отключил сервер"                    # Пример: задачи по отключению серверов
  - "Отключил промежуточную точку"       # Пример: задачи по отключению промежуточных точек
  # Добавьте свои заголовки задач для мониторинга

# Сопоставление пользователей Wrike с Telegram-упоминаниями
# Формат: "Имя в Wrike": "Отображение в Telegram"
user_names:
  IT: "IT: @Group"                    # Группа IT получает уведомления
  DR: "DR: @Drop"                     # Группа DR получает уведомления  
  "Name lastname": "Name lastname"    # Индивидуальные пользователи
  # Добавьте соответствия для ваших пользователей

# Перевод уровней важности с английского на русский
importance_translation:
  High: "Высокая"      # Высокая важность
  Normal: "Обычная"    # Обычная важность
  Low: "Низкая"        # Низкая важность

# Слова, которые будут заменены на эмоджи в комментариях
synonyms:
  # Слова, которые будут заменены на ✅ (включение/подключение)
  include:
    - "Вкл"
    - "Вклю"
    - "Включ"
    - "Включи"
    - "Включил"
    - "Включили"
    - "Включение"
    - "Включены"
    - "Включено"
    - "Включила"
    - "Включала"
    - "Включали"
    - "Подкл"
    - "Подклю"
    - "Подключ"
    - "Подключи"
    - "Подключил"
    - "Подключены"
    - "Подключили"
    - "Подключено"
    - "Подключила"
    - "Подключала"
    - "Подключали"
    
  # Слова, которые будут заменены на 🔥 (выключение/отключение)
  exclude:
    - "Выкл"
    - "Выклю"
    - "Выключ"
    - "Выключи"
    - "Выключил"
    - "Выключили"
    - "Выключено"
    - "Выключены"
    - "Выключила"
    - "Выключала"
    - "Выключали"
    - "Откл"
    - "Отклю"
    - "Отключ"
    - "Отключи"
    - "Отключил"
    - "Отключили"
    - "Отключено"
    - "Отключены"
    - "Отключила"
    - "Отключала"
    - "Отключали"

# ===========================================
# НАСТРОЙКИ КЭШИРОВАНИЯ
# ===========================================

# Кэширование данных Wrike для уменьшения нагрузки на API
cache_settings:
  projects_ttl: 172800    # Время жизни кэша проектов (48 часов = 172800 секунд)
  users_ttl: 172800       # Время жизни кэша пользователей (48 часов = 172800 секунд)
  max_size: 100           # Максимальное количество элементов в кэше

# ===========================================
# НАСТРОЙКИ ЛОГИРОВАНИЯ
# ===========================================

# Настройка уровней логирования и форматов
logging_settings:
  level: INFO                   # Доступные уровни: DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: json                  # Доступные форматы: json, text
  handlers:                     # Настройки обработчиков
    file:                       # Настройки файлового обработчика логов
      enabled: true             # включает запись логов в файл
      filename: "logging/webhook.log"   # Имя лог-файла
      max_size_mb: 10           # Максимальный размер лог-файла в мегабайтах
      backup_count: 5           # Количество резервных лог-файлов
    console:                    # Настройки консольного обработчика
      enabled: true
  fields:                       # Дополнительные поля для лог-файла
    app_name: "wrike_webhook"   # Идентификатор приложения в логах
    environment: "production"   # Среда разработки

# ===========================================
# НАСТРОЙКИ АДМИН-ПАНЕЛИ
# ===========================================

# Логин и пароль для доступа к админ-панели
# ВАЖНО: Обязательно измените логин и пароль по умолчанию!
admin_panel:
  username: "admin"       # Логин для доступа к админ-панели (ОБЯЗАТЕЛЬНО ИЗМЕНИТЕ!)
  password: "admin"       # Пароль для доступа к админ-панели (ОБЯЗАТЕЛЬНО ИЗМЕНИТЕ!)
```

### Объяснение основных настроек:

#### **task_titles** - Фильтр задач
- Указывает, какие задачи отслеживать по заголовку
- Система обрабатывает только задачи с указанными заголовками
- Добавьте свои заголовки для мониторинга

#### **user_names** - Сопоставление пользователей  
- Связывает пользователей Wrike с Telegram-упоминаниями
- При уведомлениях имена заменяются на Telegram-теги
- Формат: `"Имя в Wrike": "Отображение в Telegram"`

#### **synonyms** - Автоматические эмоджи
- **include** - слова заменяются на ✅ (включение/подключение)
- **exclude** - слова заменяются на 🔥 (выключение/отключение)
- Включает различные формы слов и опечатки для надежности

#### **cache_settings** - Оптимизация производительности
- Кэширование данных Wrike для уменьшения нагрузки на API
- Настройка времени жизни и размера кэша

#### **logging_settings** - Мониторинг системы
- Настройка уровней логирования и форматов
- Ротация логов для экономии места
- Вывод в файл и консоль

## Примеры использования

### Пример уведомления в Telegram

Когда в Wrike происходит изменение задачи с заголовком "Отключил сервер", система отправляет в Telegram сообщение:

```
Проект: ***#ИД123*** 🔥
```
Заголовок: Отключил сервер
```
Статус: Active
Важность: Высокая
Автор: Иван Петров
Исполнитель(и): Сидоров Алексей
Дата создания: 2025-01-15 14:30:25
Описание: Отключение сервера для технического обслуживания
Ссылка на задачу: https://www.wrike.com/open.htm?id=123456789
```

![Отключил](https://github.com/user-attachments/assets/c5a1f8b8-a6c2-4537-adee-023494a23649)

### Пример с комментарием

При добавлении комментария "Включил обратно" система автоматически добавит эмоджи:

```
Проект: ***#ИД123*** ✅
```
Заголовок: Отключил сервер
```
Статус: Active
Важность: Высокая
Автор: Иван Петров
Исполнитель(и): Сидоров Алексей
Дата создания: 2025-01-15 14:30:25
Описание: Отключение сервера для технического обслуживания
Ссылка на задачу: https://www.wrike.com/open.htm?id=123456789
```
```
Добавлен комментарий:
Автор: Иван Петров
Дата: 2025-10-23 12:44:08
Текст: ✅ Включил сервер
```

![Включил](https://github.com/user-attachments/assets/bcb47dc1-d3ba-4a6d-960b-ef3f623acc04)


### Настройка для разных команд

```yaml
# Для IT-отдела
task_titles:
  - "Критический инцидент"
  - "Обновление сервера"
  - "Проблема с сетью"

user_names:
  "IT Team": "IT: @it_team @admin_user"
  "DevOps": "DevOps: @devops_chat"

# Для службы поддержки
task_titles:
  - "Обращение клиента"
  - "Техническая проблема"
  - "Запрос на помощь"

user_names:
  "Support Team": "Поддержка: @support_team"
  "Manager": "Менеджер: @manager_user"
```

## Устранение неполадок


1. **Служба не запускается**
   ```bash
   sudo systemctl status webhook.service
   sudo journalctl -u webhook.service -f
   ```

2. **Ngrok не работает**
   ```bash
   sudo systemctl status ngrok.service
   curl http://localhost:4040/api/tunnels
   ```

3. **Ошибки подключения к Wrike**
   - Проверьте токен в `.env`
   - Убедитесь в доступности API Wrike
   - Проверьте логи: `tail -f logging/webhook.log`

4. **Telegram не получает сообщения**
   - Проверьте токен бота и ID чата
   - Убедитесь, что бот добавлен в чат
   - Проверьте права бота на отправку сообщений

### Полезные команды:

```bash
# Перезапуск служб
sudo systemctl restart webhook.service ngrok.service

# Просмотр логов
tail -f logging/webhook.log

# Проверка статуса всех служб
sudo systemctl status webhook.service ngrok.service
```

### Внешние сервисы:
- **Wrike API** - токен доступа к API Wrike
- **Telegram Bot** - токен бота и ID чата
- **Ngrok** - аккаунт для туннелирования (бесплатный план работает только для 1 сессии)

## FAQ

### Q: Как получить токен Wrike API?
Зайдите в Wrike → Приложения и интеграция → API → Создать приложение → Получить токен

### Q: Как узнать ID чата Telegram?
Добавьте бота @userinfobot в чат и отправьте команду `/start` - он покажет ID чата

### Q: Почему не приходят уведомления?
Проверьте:
- Запущены ли службы: `sudo systemctl status webhook.service ngrok.service`
- Правильность токенов в `.env`
- Настройки фильтра задач в `config.yaml`
- Логи: `tail -f logging/webhook.log`

### Q: Как изменить порт приложения?
В файле `webhook.py` измените параметр `port=5555` на нужный порт

### Q: Можно ли использовать без ngrok?
Да, если у вас есть статический IP и настроен порт-форвардинг, или используйте другие туннели

### Q: Как добавить новые типы задач для мониторинга?
Добавьте заголовки в секцию `task_titles` файла `config.yaml`

### Q: Как настроить для нескольких команд?
Создайте отдельные экземпляры приложения с разными конфигурациями или используйте фильтрацию по проектам
